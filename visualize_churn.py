import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.dates as mdates
import datetime

def visualize_churn_data(filename):
    """
    Loads synthetic churn data and plots a smooth 7-day rolling average
    of daily churn counts to visualize peaks and trends over the last 90 days.

    Args:
        filename (str): The path to the synthetic churn CSV file.
    """
    print(f"Loading synthetic churn data from '{filename}'...")
    try:
        df = pd.read_csv(filename)
    except FileNotFoundError:
        print(f"ERROR: File not found at '{filename}'.")
        return

    # --- 1. Data Preparation and Filtering ---
    df['acct_suspd_date'] = pd.to_datetime(df['acct_suspd_date'], errors='coerce')
    churned_customers = df.dropna(subset=['acct_suspd_date'])

    end_date_limit = datetime.datetime.now().date()
    start_date_limit = end_date_limit - datetime.timedelta(days=90)
    
    churned_customers_in_window = churned_customers[
        (churned_customers['acct_suspd_date'].dt.date >= start_date_limit) &
        (churned_customers['acct_suspd_date'].dt.date <= end_date_limit)
    ]

    if churned_customers_in_window.empty:
        print("No churn events found in the last 90 days to plot.")
        return

    print(f"Found {len(churned_customers_in_window)} total churn events in the last 90 days.")

    # --- 2. Time Series Aggregation ---
    daily_churn_counts = churned_customers_in_window.groupby('acct_suspd_date').size().rename('daily_churns')
    date_range = pd.date_range(start=start_date_limit, end=end_date_limit)
    daily_churn_counts = daily_churn_counts.reindex(date_range, fill_value=0)
    
    # Calculate the 7-day rolling average, which will be our smooth trendline.
    rolling_avg = daily_churn_counts.rolling(window=3, center=True, min_periods=1).mean()

    # --- 3. Visualization (Now with a focus on the line graph) ---
    print("Generating smooth line graph for the last 90 days...")
    plt.style.use('seaborn-v0_8-whitegrid')
    fig, ax = plt.subplots(figsize=(18, 9))

    ax.bar(daily_churn_counts.index, daily_churn_counts, color='lightgray', alpha=0.6, label='Daily Churn Events')
    # Plot the rolling average as a smooth line.
    ax.plot(rolling_avg.index, rolling_avg, color='steelblue', 
            linestyle='-', linewidth=2.5, label='3-Day Rolling Average of Churn')

    # Optional: You can add markers to see the points more clearly
    # ax.plot(rolling_avg.index, rolling_avg, color='steelblue', linestyle='-', 
    #         linewidth=2.5, marker='o', markersize=5, label='7-Day Rolling Average of Churn')


    # --- 4. Formatting the Plot ---    
    ax.set_title('Insurance Churn Trend Over the Last 90 Days', fontsize=22, pad=20)
    ax.set_xlabel('Date', fontsize=14)
    ax.set_ylabel('Average Daily Churn Events', fontsize=14)
    ax.legend(fontsize=12)
    
    # Set a minimum y-axis value to start from 0 for better perspective
    ax.set_ylim(bottom=0)
    
    ax.set_xlim([start_date_limit, end_date_limit])
    
    ax.xaxis.set_major_locator(mdates.WeekdayLocator(interval=2))
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))
    plt.xticks(rotation=45, ha="right")
    
    ax.grid(True, which='both', linestyle='--', linewidth=0.5)
    fig.tight_layout()
    
    output_filename = 'churn_trend_line_graph.png'
    plt.savefig(output_filename, dpi=300)
    print(f"Plot saved successfully as '{output_filename}'")
    plt.show()

def main():
    """Main function to run the visualization script."""
    # Ensure you are using the correct CSV file generated by the Gemini script
    SYNTHETIC_DATA_FILENAME = 'gemini_selected_event_data_90days.csv'
    
    visualize_churn_data(SYNTHETIC_DATA_FILENAME)

if __name__ == "__main__":
    main()