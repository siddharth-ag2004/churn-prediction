<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Churn Prediction</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #4f46e5;
            --color-secondary: #ec4899;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #c7ceea 100%);
            background-attachment: fixed;
            color: #334155;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border-radius: 1rem;
        }

        input[type="number"],
        input[type="text"],
        select,
        textarea {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            color: #1f2937 !important;
        }

        input[type="checkbox"] {
            accent-color: #4f46e5;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        button[type="submit"]:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }

        .sidebar-nav a {
            color: #475569;
            transition: all 0.2s ease;
        }

        .sidebar-nav a:hover {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.1);
        }

        .sidebar-nav a.active {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.15);
            border-left: 3px solid #4f46e5;
        }

        .chart-container {
            padding: 1.5rem;
            min-height: 400px;
        }
    </style>
</head>
<body>

    <div class="flex h-screen">
        <!-- Static Sidebar with Glass Effect -->
        <aside class="w-64 glass-effect flex-shrink-0 !rounded-none !border-r !border-l-0 !border-t-0 !border-b-0 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="text-2xl font-bold text-gray-800">Churn AI</span>
                </div>
            </div>
            <nav class="mt-8 px-4 sidebar-nav">
                <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-3 mt-2 rounded-lg {% if request.endpoint == 'index' %}active{% endif %}">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('predict') }}" class="flex items-center gap-3 px-4 py-3 mt-2 rounded-lg {% if request.endpoint == 'predict' %}active{% endif %}">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span>Prediction</span>
                </a>
                <a href="{{ url_for('insights') }}" class="flex items-center gap-3 px-4 py-3 mt-2 rounded-lg {% if request.endpoint == 'insights' %}active{% endif %}">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    <span>Insights</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <header class="mb-8">
                    <h1 class="text-4xl font-bold text-gray-800">Individual Churn Prediction</h1>
                    <p class="text-gray-600 mt-2">Enter a customer's details to get their churn risk and prediction explanation.</p>
                </header>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
    <div class="glass-effect p-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Customer Details</h2>
        <form action="/predict" method="POST">
            <div class="space-y-5">
                <div>
                    <label for="tenure" class="block text-sm font-medium text-gray-700 mb-2">Days of Tenure</label>
                    <input type="number" id="tenure" name="tenure" class="w-full px-4 py-2 rounded-lg shadow-sm" value="{{ form_data.tenure }}" required>
                </div>
                <div>
                    <label for="annual_premium" class="block text-sm font-medium text-gray-700 mb-2">Current Annual Premium ($)</label>
                    <input type="number" step="0.01" id="annual_premium" name="annual_premium" class="w-full px-4 py-2 rounded-lg shadow-sm" value="{{ form_data.annual_premium }}" required>
                </div>
                <div>
                    <label for="income" class="block text-sm font-medium text-gray-700 mb-2">Annual Income ($)</label>
                    <input type="number" id="income" name="income" class="w-full px-4 py-2 rounded-lg shadow-sm" value="{{ form_data.income }}" required>
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700 mb-2">Age in Years</label>
                    <input type="number" id="age" name="age" class="w-full px-4 py-2 rounded-lg shadow-sm" value="{{ form_data.age }}" required>
                </div>
                <div>
                    <label for="marital_status" class="block text-sm font-medium text-gray-700 mb-2">Marital Status</label>
                    <select id="marital_status" name="marital_status" class="w-full px-4 py-2 rounded-lg shadow-sm" required>
                        <option value="Married" {% if form_data.marital_status == 'Married' %}selected{% endif %}>Married</option>
                        <option value="Single" {% if form_data.marital_status == 'Single' %}selected{% endif %}>Single</option>
                        <option value="Unknown" {% if form_data.marital_status == 'Unknown' %}selected{% endif %}>Unknown</option>
                    </select>
                </div>
                <div>
                    <label for="home_owner" class="block text-sm font-medium text-gray-700 mb-2">Home Ownership</label>
                    <select id="home_owner" name="home_owner" class="w-full px-4 py-2 rounded-lg shadow-sm" required>
                        <option value="0" {% if form_data.home_owner == '0' %}selected{% endif %}>Renter</option>
                        <option value="1" {% if form_data.home_owner == '1' %}selected{% endif %}>Owner</option>
                    </select>
                </div>
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="good_credit" name="good_credit" class="h-4 w-4 rounded" {% if form_data.good_credit %}checked{% endif %}>
                    <label for="good_credit" class="ml-3 block text-sm font-medium text-gray-700">Has Good Credit?</label>
                </div>
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="has_children" name="has_children" class="h-4 w-4 rounded" {% if form_data.has_children %}checked{% endif %}>
                    <label for="has_children" class="ml-3 block text-sm font-medium text-gray-700">Has Children?</label>
                </div>
            </div>
            <button type="submit" class="mt-8 w-full py-3 px-4 rounded-lg hover:shadow-lg transition-all">
                Predict Churn Risk
            </button>
        </form>
    </div>
</div>

                    <!-- Results Column -->
                    <div class="lg:col-span-2">
                        {% if prediction_data %}
                        <div class="grid grid-cols-1 gap-8">
                            <!-- Churn Score Gauge -->
                            <div class="glass-effect p-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Churn Probability Score</h2>
                                <div class="flex flex-col items-center justify-center">
                                    <div class="relative" style="width: 350px; height: 250px;">
                                        <canvas id="churnGauge"></canvas>
                                    </div>
                                    <div class="mt-6 text-center">
                                        <p class="text-5xl font-bold" id="probabilityText">0%</p>
                                        <p class="text-sm text-gray-600 mt-2" id="riskLabel">Risk Level</p>
                                    </div>
                                </div>
                            </div>

                            <!-- SHAP Waterfall Explanation -->
                            <div class="glass-effect p-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Prediction Factors (SHAP Explanation)</h2>
                                <div style="height: 450px;">
                                    <canvas id="shapWaterfall"></canvas>
                                </div>
                            </div>

                            <!-- Discount Analysis Chart -->
                            <div class="glass-effect p-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Discount Impact Analysis</h2>
                                <div style="height: 400px;">
                                    <canvas id="discountChart"></canvas>
                                </div>
                            </div>

                            <!-- Premium Comparison Card -->
                            <div class="glass-effect p-6">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Premium Comparison</h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white bg-opacity-50 p-4 rounded-lg text-center">
                                        <p class="text-sm text-gray-600 mb-2">Current Premium</p>
                                        <p class="text-2xl font-bold text-gray-800" id="currentPremiumDisplay">$0</p>
                                    </div>
                                    <div class="bg-green-50 bg-opacity-70 p-4 rounded-lg text-center border border-green-200">
                                        <p class="text-sm text-green-700 font-medium mb-2">Discounted Premium</p>
                                        <p class="text-2xl font-bold text-green-600" id="discountedPremiumDisplay">$0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="glass-effect p-8 flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                                </svg>
                                <h3 class="text-lg font-semibold text-gray-800">No Prediction Yet</h3>
                                <p class="mt-2 text-sm text-gray-600">
                                    Submit customer details to see the results.
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    {% if prediction_data %}
    <script>
        // Set Chart.js defaults for the new theme
        Chart.defaults.color = 'rgba(51, 65, 85, 0.7)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.3)';

        const probability = {{ prediction_data.probability }};
        const explanation_data = {{ prediction_data.explanation | tojson }};

        // Function to get color based on probability (Green -> Yellow -> Red)
        function getColorForProbability(prob) {
            if (prob < 0.33) {
                // Green zone
                return `rgba(16, 185, 129, ${0.7 + prob * 0.3})`;
            } else if (prob < 0.67) {
                // Yellow/Orange zone
                return `rgba(245, 158, 11, ${0.7 + (prob - 0.33) * 0.3})`;
            } else {
                // Red zone
                return `rgba(239, 68, 68, ${0.7 + (prob - 0.67) * 0.3})`;
            }
        }

        function getRiskLabel(prob) {
            if (prob < 0.33) return 'Low Risk';
            if (prob < 0.67) return 'Medium Risk';
            return 'High Risk';
        }

        // SPEEDOMETER GAUGE CHART
        const ctx = document.getElementById('churnGauge').getContext('2d');
        
        // Create gradient for the gauge background
        const gaugeGradient = ctx.createLinearGradient(0, 0, 350, 0);
        gaugeGradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
        gaugeGradient.addColorStop(0.5, 'rgba(245, 158, 11, 0.8)');
        gaugeGradient.addColorStop(1, 'rgba(239, 68, 68, 0.8)');

        const gaugeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [probability * 100, (1 - probability) * 100],
                    backgroundColor: [
                        getColorForProbability(probability),
                        'rgba(226, 232, 240, 0.3)'
                    ],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                cutout: '75%'
            }
        });

        // Update probability text and risk label
        document.getElementById('probabilityText').textContent = (probability * 100).toFixed(1) + '%';
        document.getElementById('probabilityText').style.color = getColorForProbability(probability);
        document.getElementById('riskLabel').textContent = getRiskLabel(probability);

        // SHAP WATERFALL CHART
        const shapCtx = document.getElementById('shapWaterfall').getContext('2d');
        
        // Prepare data for waterfall chart
        const features = explanation_data.explanation.map(item => item.feature);
        const values = explanation_data.explanation.map(item => item.value);
        const baseValue = explanation_data.base_value;
        
        // Create cumulative values for waterfall effect
        let cumulative = baseValue;
        const cumulativeValues = [baseValue];
        
        for (let i = 0; i < values.length; i++) {
            cumulative += values[i];
            cumulativeValues.push(cumulative);
        }

        // Colors for positive and negative contributions
        const barColors = values.map(val => 
            val > 0 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)'
        );

        const shapChart = new Chart(shapCtx, {
            type: 'bar',
            data: {
                labels: ['Base', ...features],
                datasets: [{
                    label: 'SHAP Value',
                    data: [baseValue, ...values],
                    backgroundColor: ['rgba(59, 130, 246, 0.7)', ...barColors],
                    borderColor: ['rgba(59, 130, 246, 1)', ...barColors.map(c => c.replace('0.7', '1'))],
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#1f2937',
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.x;
                                return `Impact: ${value > 0 ? '+' : ''}${value.toFixed(4)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    }
                }
            }
        });

        // DISCOUNT ANALYSIS CHART
        const discountData = {{ prediction_data.discount_analysis | tojson }};
        const discountCtx = document.getElementById('discountChart').getContext('2d');
        
        // Get current premium from form input
        const currentPremium = parseFloat(document.getElementById('annual_premium').value);
        const discount_to_provide = {{ prediction_data.suggested_discount | tojson }};
        const discountedPremium = currentPremium * (1 - (discount_to_provide / 100));

        document.getElementById('currentPremiumDisplay').textContent = '$' + currentPremium.toFixed(2);
        document.getElementById('discountedPremiumDisplay').textContent = '$' + discountedPremium.toFixed(2);
        // Prepare data
        const discountLabels = ['Current', ...discountData.map(d => `${d.discount_pct}% Off`)];
        const discountProbabilities = [probability * 100, ...discountData.map(d => d.new_probability * 100)];
        const discountPremiums = [currentPremium, ...discountData.map(d => d.new_premium)];
        
        const discountChart = new Chart(discountCtx, {
            type: 'line',
            data: {
                labels: discountLabels,
                datasets: [
                    {
                        label: 'Churn Probability (%)',
                        data: discountProbabilities,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Annual Premium ($)',
                        data: discountPremiums,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#1f2937',
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Churn Probability (%)',
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: 'rgba(239, 68, 68, 1)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + '%';
                            },
                            font: {
                                size: 11
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Annual Premium ($)',
                            font: {
                                size: 13,
                                weight: '600'
                            },
                            color: 'rgba(59, 130, 246, 1)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            },
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });

        
    </script>
    {% endif %}


</body>
</html>