<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Churn Prediction</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- LIGHT GLASSMORPHISM REDESIGN --- */

        :root {
            --color-primary: #4f46e5; /* Indigo */
            --color-secondary: #ec4899; /* Pink */
            --color-success: #10b981;  /* Emerald */
            --color-warning: #f59e0b;  /* Amber */
            --color-danger: #ef4444;   /* Red */
            --color-info: #3b82f6;    /* Blue */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #c7ceea 100%);
            background-attachment: fixed;
            color: #334155;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Base class for all glass elements */
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 1rem;
        }

        input[type="number"],
        input[type="text"],
        select,
        textarea {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            color: #1f2937 !important;
        }

        input[type="checkbox"] {
            accent-color: #4f46e5;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        button[type="submit"]:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }

        .sidebar-nav a {
            color: #475569;
            transition: all 0.2s ease;
        }

        .sidebar-nav a:hover {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.1);
        }

        .sidebar-nav a.active {
            color: #4f46e5;
            background: rgba(79, 70, 229, 0.15);
            border-left: 3px solid #4f46e5;
        }

        .chart-container {
            padding: 1.5rem;
            min-height: 400px;
        }
    </style>
</head>
<body>

    <div class="flex h-screen">
        <!-- Static Sidebar with Glass Effect -->
        <aside class="w-64 glass-effect flex-shrink-0 !rounded-none !border-r !border-l-0 !border-t-0 !border-b-0 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <span class="text-2xl font-bold text-gray-800">Churn AI</span>
                </div>
            </div>
            <nav class="mt-8 px-4 sidebar-nav">
                <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-3 mt-2 rounded-lg {% if request.endpoint == 'index' %}active{% endif %}">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('predict') }}" class="flex items-center gap-3 px-4 py-3 mt-2 rounded-lg {% if request.endpoint == 'predict' %}active{% endif %}">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span>Prediction</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <header class="mb-8">
                    <h1 class="text-4xl font-bold text-gray-800">Individual Churn Prediction</h1>
                    <p class="text-gray-600 mt-2">Enter a customer's details to get their churn risk and prediction explanation.</p>
                </header>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Input Form Column -->
                    <div class="lg:col-span-1">
                        <div class="glass-effect p-8">
                            <h2 class="text-xl font-semibold text-gray-800 mb-6">Customer Details</h2>
                            <form action="/predict" method="POST">
                                <div class="space-y-5">
                                    <div>
                                        <label for="tenure" class="block text-sm font-medium text-gray-700 mb-2">Days of Tenure</label>
                                        <input type="number" id="tenure" name="tenure" class="w-full px-4 py-2 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="500" required>
                                    </div>
                                    <div>
                                        <label for="annual_premium" class="block text-sm font-medium text-gray-700 mb-2">Current Annual Premium ($)</label>
                                        <input type="number" step="0.01" id="annual_premium" name="annual_premium" class="w-full px-4 py-2 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="1200.50" required>
                                    </div>
                                    <div>
                                        <label for="income" class="block text-sm font-medium text-gray-700 mb-2">Annual Income ($)</label>
                                        <input type="number" id="income" name="income" class="w-full px-4 py-2 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="65000" required>
                                    </div>
                                    <div>
                                        <label for="age" class="block text-sm font-medium text-gray-700 mb-2">Age in Years</label>
                                        <input type="number" id="age" name="age" class="w-full px-4 py-2 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="45" required>
                                    </div>
                                    <div class="flex items-center pt-2">
                                        <input type="checkbox" id="good_credit" name="good_credit" class="h-4 w-4 rounded" checked>
                                        <label for="good_credit" class="ml-3 block text-sm font-medium text-gray-700">Has Good Credit?</label>
                                    </div>
                                </div>
                                <button type="submit" class="mt-8 w-full py-3 px-4 rounded-lg hover:shadow-lg transition-all">
                                    Predict Churn Risk
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Results Column -->
                    <div class="lg:col-span-2">
                        {% if prediction_data %}
                        <div class="grid grid-cols-1 gap-8">
                            <!-- Churn Score Gauge -->
                            <div class="glass-effect p-8 flex flex-col items-center justify-center">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Churn Probability Score</h2>
                                <div class="w-full max-w-xs">
                                    <canvas id="churnGauge"></canvas>
                                </div>
                            </div>

                            <!-- SHAP Waterfall Explanation -->
                            <div class="glass-effect p-8">
                                <h2 class="text-xl font-semibold text-gray-800 mb-6">Prediction Factors (SHAP Explanation)</h2>
                                <div style="height: 450px;">
                                    <canvas id="shapWaterfall"></canvas>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="glass-effect p-8 flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                                </svg>
                                <h3 class="text-lg font-semibold text-gray-800">No Prediction Yet</h3>
                                <p class="mt-2 text-sm text-gray-600">
                                    Submit customer details to see the results.
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    {% if prediction_data %}
    <script src="https://cdn.jsdelivr.net/npm/chartjs-gauge@0.3.0/dist/chartjs-gauge.min.js"></script>
    <script>
        // --- Set Chart.js defaults for the new theme ---
        Chart.defaults.color = 'rgba(51, 65, 85, 0.7)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.3)';

        // Color palette
        const colorPalette = {
            primary: 'rgba(79, 70, 229, 0.8)',
            secondary: 'rgba(236, 72, 153, 0.8)',
            success: 'rgba(16, 185, 129, 0.8)',
            warning: 'rgba(245, 158, 11, 0.8)',
            danger: 'rgba(239, 68, 68, 0.8)',
            info: 'rgba(59, 130, 246, 0.8)',
        };

        // --- GAUGE CHART ---
        const probability = {{ prediction_data.probability }};
        const gaugeCtx = document.getElementById('churnGauge').getContext('2d');
        new Chart(gaugeCtx, {
            type: 'gauge',
            data: {
                datasets: [{
                    value: probability * 100,
                    data: [25, 50, 75, 100],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#b91c1c'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                needle: { radiusPercentage: 2, widthPercentage: 3, lengthPercentage: 80, color: 'rgba(51, 65, 85, 0.9)' },
                valueLabel: {
                    display: true,
                    formatter: (value) => `${value.toFixed(1)}%`,
                    color: 'rgba(51, 65, 85, 1)',
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    borderRadius: 5,
                    padding: { top: 10 },
                    fontSize: 28
                }
            }
        });

        // --- WATERFALL CHART (SHAP EXPLANATION) ---
        const explanationData = {{ prediction_data.explanation | tojson }};
        const shapCtx = document.getElementById('shapWaterfall').getContext('2d');
        
        let runningTotal = explanationData.base_value;
        const dataPoints = explanationData.explanation.map(item => {
            const start = runningTotal;
            const end = runningTotal + item.value;
            runningTotal = end;
            return { start, end };
        });

        const finalScore = runningTotal;

        const labels = explanationData.explanation.map(item => `${item.feature}`);
        const data = {
            labels: ['Base', ...labels, 'Final Score'],
            datasets: [{
                data: [
                    [0, explanationData.base_value],
                    ...dataPoints.map(p => [p.start, p.end]),
                    [0, finalScore]
                ],
                backgroundColor: (ctx) => {
                    if (ctx.dataIndex === 0 || ctx.dataIndex === data.labels.length - 1) return 'rgba(59, 130, 246, 0.8)'; // Blue for base/final
                    const value = explanationData.explanation[ctx.dataIndex - 1].value;
                    return value > 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)'; // Red for increase, Green for decrease
                },
                barPercentage: 0.9,
                borderRadius: 4
            }]
        };

        new Chart(shapCtx, {
            type: 'bar',
            data: data,
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { display: false } },
                    x: {
                        title: { display: true, text: 'Impact on Churn Probability', color: 'rgba(51, 65, 85, 0.7)' },
                        beginAtZero: false
                    }
                }
            }
        });
    </script>
    {% endif %}

</body>
</html>